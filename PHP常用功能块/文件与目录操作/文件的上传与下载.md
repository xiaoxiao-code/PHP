# 文件的上传与下载

# 1 文件上传

文件上传在PHP中主要涉及两个部分：HTML表单的特殊设置，以及服务器端`$_FILES`变量和`move_uploaded_file()`函数的处理。
## 1.1 HTML表单设置
要使 HTML 表单能够上传文件，必须满足以下两个条件：
1. `method`必须是`post`。
2. `enctype`属性必须设置为`multipart/form-data` 。
```php
<form action="upload.php" method="post" enctype="multipart/form-data">
    <input type="file" name="myFile">
    <input type="submit" value="上传">
</form>
```
## 1.2 PHP服务器端处理
当文件上传后，PHP 将文件信息存储在一个特殊的预定义变量`$_FILES`中。
### 1.2.1 `$_FILES`超全局变量
`$_FILES`是一个二维仓库，包含了所上传文件的详细信息。假设`input`标签的`name`属性是“myFile”( `name="myFile"`)：
- `$_FILES['myFile']['name']`： 客户端上的原始文件名。
- `$_FILES['myFile']['type']`： 文件的MIME类型，例如`image/gif` 。
- `$_FILES['myFile']['size']`： 文件的大小，单位为字节。
- `$_FILES['myFile']['tmp_name']`： 文件被上传后，存储在服务器上的临时文件路径 。
- `$_FILES['myFile']['error']`： 上传错误代码。 值为0表示没有错误。
### 1.2.2 `move_uploaded_file()`函数
文件上传后，首先被存放在一个临时目录（由`tmp_name`指定）中。必须使用`move_uploaded_file()`函数将此临时文件移动到您指定的最终目标位置。
- 格式： 
```php
move_uploaded_file("临时文件路径", "目标文件路径");
```
- 功能：将已上传的文件（`"临时文件路径"`）移动到新的位置（`"目标文件路径"`）。
示例
```php
<?php
// 检查是否有文件上传
if (isset($_FILES['myFile'])) {
    
    // 获取临时文件路径
    $tmp_file = $_FILES['myFile']['tmp_name'];
    
    // 设置目标文件路径
    $target_file = "upload/" . $_FILES['myFile']['name'];
    
    // 移动文件
    if (move_uploaded_file($tmp_file, $target_file)) {
        echo "文件上传成功！";
    } else {
        echo "文件上传失败。";
    }
}
?>
```
# 2 文件下载
文件下载的原理是PHP脚本先发送特定的HTTP标头（头）告知浏览器是一个需要下载的文件，然后使用文件读取函数将文件输出内容给浏览器。
## 2.1 使用`header()`函数发送标头
在 PHP 脚本中，必须在编写任何内容（包括 HTML 和空格）之前，使用`header()`函数发送标头。
对于文件下载，通常需要设置两个关键标头：
### 2.1.1 `Content-Type:`
- 功能：告诉浏览器文件的MIME类型。
- 译文：
```php
header("Content-Type: image/jpeg");
```
- 如果不确定的二进制文件，可以使用`application/octet-stream` 。
### 2.1.2 `Content-Disposition:`
- 功能：这是强制浏览器弹出“另存为”下载对话框的按键。
- 格式：
```php
header("Content-Disposition: attachment; filename=文件名");
```
- `attachment`表示作为附件下载。
- `filename=`指定了下载时默认显示的文件名。
## 2.2 使用`readfile()`函数输出文件
发送完成标头后，需要将文件内容发送给浏览器。
- 函数： `readfile()`
- 格式： 
```php
readfile("文件路径");
```
- 功能：读取指定的文件，将其内容直接读取到输出波形（即发送给浏览器）。
```php
<?php
$file_path = "download/1.txt";
$file_name = "1.txt"; // 下载时显示的文件名

// 1. 设置标头
header("Content-Type: application/octet-stream");
header("Content-Disposition: attachment; filename=" . $file_name); 

// 2. 读取并输出文件
readfile($file_path); 
?>
```